<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contract Renewal Command Center</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        /* DASHBOARD STYLING */
        :root {
            --bg-body: #f4f6f8;
            --bg-card: #ffffff;
            --text-primary: #344767;
            --text-secondary: #7b809a;
            --danger: #ea0606;
            --warning: #f59e0b;
            --success: #10b981;
            --info: #3b82f6;
        }

        body {
            background-color: var(--bg-body);
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            color: var(--text-primary);
            padding-bottom: 50px;
        }

        /* HEADER */
       .dashboard-header {
            background: #fff;
            padding: 20px 0;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        /* CARD COMPONENT */
       .card-dashboard {
            background: var(--bg-card);
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            padding: 24px;
            height: 100%;
            transition: transform 0.2s;
            border: 0;
        }
        
        /* KPI STYLES */
       .kpi-icon {
            width: 48px;
            height: 48px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            margin-bottom: 16px;
        }
       .kpi-blue { background-color: #e3f2fd; color: var(--info); }
       .kpi-green { background-color: #d1fae5; color: var(--success); }
       .kpi-red { background-color: #fee2e2; color: var(--danger); }
       .kpi-yellow { background-color: #fef3c7; color: var(--warning); }

       .kpi-value {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 4px;
            color: var(--text-primary);
        }

       .kpi-label {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* CHART CONTAINER */
       .chart-wrapper {
            min-height: 500px;
            position: relative;
        }

        /* TABLE STYLING */
        #contractsTable thead th {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
            font-weight: 700;
            border-bottom: 2px solid #edf2f7;
        }
        
        /* STATUS BADGES */
       .badge-status {
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
        }
       .bg-critical { background-color: #fee2e2; color: #991b1b; }
       .bg-warning { background-color: #fef3c7; color: #92400e; }
       .bg-good { background-color: #d1fae5; color: #065f46; }
       .bg-expired { background-color: #e5e7eb; color: #374151; }

        /* CUSTOM TOOLTIP */
       .apexcharts-tooltip-custom {
            background: #1f2937!important;
            border: 1px solid #1f2937!important;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
            border-radius: 6px;
            color: #fff;
            overflow: hidden;
            pointer-events: none;
        }
       .tooltip-header {
            background: #111827;
            padding: 10px 14px;
            font-weight: 700;
            font-size: 13px;
            border-bottom: 1px solid #374151;
        }
       .tooltip-body {
            padding: 12px 14px;
            font-size: 12px;
            line-height: 1.6;
        }
       .tooltip-row {
            display: flex;
            justify-content: space-between;
            gap: 15px;
        }
       .tooltip-val { font-weight: 600; color: #e5e7eb; }
       .tooltip-lbl { color: #9ca3af; }

    </style>
</head>
<body>

    <header class="dashboard-header">
        <div class="container-fluid px-4">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h4 class="mb-1 fw-bold"><i class="fa-solid fa-file-contract me-2 text-primary"></i>Renewal Command Center</h4>
                    <p class="mb-0 text-muted small">Visual Analytics for Contract Lifecycle Management</p>
                </div>
                <div class="col-md-6 text-md-end mt-3 mt-md-0">
                    <div class="d-inline-flex align-items-center bg-white border rounded p-2 shadow-sm">
                        <i class="fa-solid fa-upload text-muted ms-2 me-2"></i>
                        <input type="file" id="csvInput" accept=".csv" class="form-control form-control-sm border-0" style="width: 250px;">
                        <button class="btn btn-sm btn-primary ms-2" onclick="window.print()"><i class="fa-solid fa-print me-1"></i> Report</button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="container-fluid px-4">
        
        <div class="row g-4 mb-4">
            <div class="col-xl-3 col-md-6">
                <div class="card-dashboard">
                    <div class="kpi-icon kpi-blue"><i class="fa-solid fa-sack-dollar"></i></div>
                    <div class="kpi-value" id="kpi-total-value">-</div>
                    <div class="kpi-label">Total Contract Value (Active)</div>
                </div>
            </div>
            
            <div class="col-xl-3 col-md-6">
                <div class="card-dashboard">
                    <div class="kpi-icon kpi-red"><i class="fa-solid fa-triangle-exclamation"></i></div>
                    <div class="kpi-value" id="kpi-risk-value">-</div>
                    <div class="kpi-label">Value at Risk (< 90 Days)</div>
                </div>
            </div>

            <div class="col-xl-3 col-md-6">
                <div class="card-dashboard">
                    <div class="kpi-icon kpi-yellow"><i class="fa-solid fa-clock-rotate-left"></i></div>
                    <div class="kpi-value" id="kpi-renewal-count">-</div>
                    <div class="kpi-label">Renewals Due (< 90 Days)</div>
                </div>
            </div>

            <div class="col-xl-3 col-md-6">
                <div class="card-dashboard">
                    <div class="kpi-icon kpi-green"><i class="fa-solid fa-building-columns"></i></div>
                    <div class="kpi-value" id="kpi-bureau-count">-</div>
                    <div class="kpi-label">Funding Bureaus Active</div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-12">
                <div class="card-dashboard">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5 class="fw-bold mb-0">Renewal Timeline & Workload</h5>
                        <select id="bureauFilter" class="form-select form-select-sm" style="width: 200px;" disabled>
                            <option value="ALL">All Bureaus</option>
                        </select>
                    </div>
                    <div class="chart-wrapper">
                        <div id="timelineChart"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="card-dashboard">
                    <h5 class="fw-bold mb-4">Contract Detail Register</h5>
                    <table id="contractsTable" class="table table-hover w-100">
                        <thead>
                            <tr>
                                <th>Status</th>
                                <th>Acronym</th>
                                <th>Contract #</th>
                                <th>Title</th>
                                <th>Vendor</th>
                                <th>Funding Bureau</th>
                                <th>End Date</th>
                                <th>Value</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

    <script>
        /**
         * Contract Renewal Dashboard Logic
         * Handles CSV Parsing, Data Transformation, and Visualization Rendering.
         */

        // Global State Management
        const STATE = {
            rawData:,
            processedData:,
            bureaus: new Set(),
            table: null,
            chart: null
        };

        // Utility: Currency Formatter
        const formatCurrency = new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: 'USD',
            minimumFractionDigits: 0,
            maximumFractionDigits: 0
        });

        // 1. Initialization & Event Listeners
        $(document).ready(function() {
            // Initialize empty table
            STATE.table = $('#contractsTable').DataTable({
                columns:,
                columnDefs:, targets: 6 }  // Sort dates by days left integer
                ],
                order: [[8, 'asc']], // Default sort: Most urgent first
                language: {
                    emptyTable: "Please upload a CSV file to view contract data."
                }
            });

            // File Upload Handler
            $('#csvInput').on('change', function(e) {
                const file = e.target.files;
                if (!file) return;
                
                // Show loading state could go here
                parseCSV(file);
            });

            // Filter Handler
            $('#bureauFilter').on('change', function() {
                const selectedBureau = $(this).val();
                filterDashboard(selectedBureau);
            });
        });

        // 2. Data Parsing (ETL)
        function parseCSV(file) {
            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                dynamicTyping: true, // Auto-convert numbers
                complete: function(results) {
                    transformData(results.data);
                },
                error: function(err) {
                    alert("Error parsing CSV: " + err.message);
                }
            });
        }

        // 3. Data Transformation Logic
        function transformData(data) {
            const today = new Date();
            STATE.processedData =;
            STATE.bureaus.clear();

            data.forEach(row => {
                // Validation: Ensure active row
                if (!row.contract_number) return;

                // 3.1 Date Parsing
                // Attempt to parse text dates. Works with ISO and standard US formats.
                const start = new Date(row.contract_start_date);
                const end = new Date(row.contract_end_date);
                
                // Skip invalid dates
                if (isNaN(start) |

| isNaN(end)) return;

                // 3.2 Financial Cleaning
                // Handle "$1,000.00" strings if dynamicTyping failed
                let total = row.contract_total;
                if (typeof total === 'string') {
                    total = parseFloat(total.replace(/[^0-9.-]+/g,""));
                }
                total = total |

| 0;

                // 3.3 Metric Calculation
                const timeDiff = end.getTime() - today.getTime();
                const daysLeft = Math.ceil(timeDiff / (1000 * 3600 * 24));
                
                // 3.4 Urgency Classification
                let urgency = 'GOOD';
                let color = '#10b981'; // Green
                
                if (daysLeft < 0) {
                    urgency = 'EXPIRED';
                    color = '#9ca3af'; // Grey
                } else if (daysLeft <= 30) {
                    urgency = 'CRITICAL';
                    color = '#ea0606'; // Red
                } else if (daysLeft <= 90) {
                    urgency = 'WARNING';
                    color = '#f59e0b'; // Yellow
                }

                // 3.5 Hierarchy Extraction
                const bureau = row.funding_bureau |

| "Unassigned";
                STATE.bureaus.add(bureau);

                // 3.6 Build Processed Object
                STATE.processedData.push({
                    raw: row,
                    computed: {
                        start: start,
                        end: end,
                        total: total,
                        daysLeft: daysLeft,
                        urgency: urgency,
                        color: color,
                        bureau: bureau
                    }
                });
            });

            populateFilter();
            filterDashboard("ALL"); // Initial render
        }

        // 4. UI Rendering
        function populateFilter() {
            const select = $('#bureauFilter');
            select.empty().append('<option value="ALL">All Bureaus</option>');
            Array.from(STATE.bureaus).sort().forEach(b => {
                select.append(`<option value="${b}">${b}</option>`);
            });
            select.prop('disabled', false);
        }

        function filterDashboard(bureau) {
            // Filter Data
            const subset = bureau === "ALL" 
               ? STATE.processedData 
                : STATE.processedData.filter(d => d.computed.bureau === bureau);

            updateKPIs(subset);
            renderTable(subset);
            renderChart(subset);
        }

        function updateKPIs(data) {
            const totalVal = data.reduce((acc, curr) => acc + curr.computed.total, 0);
            
            // Risk: Contracts expiring in next 90 days (excluding expired)
            const riskSet = data.filter(d => d.computed.daysLeft >= 0 && d.computed.daysLeft <= 90);
            const riskVal = riskSet.reduce((acc, curr) => acc + curr.computed.total, 0);
            const riskCount = riskSet.length;

            const bureauCount = new Set(data.map(d => d.computed.bureau)).size;

            // Animate Numbers (simple text update)
            $('#kpi-total-value').text(formatCurrency.format(totalVal));
            $('#kpi-risk-value').text(formatCurrency.format(riskVal));
            $('#kpi-renewal-count').text(riskCount);
            $('#kpi-bureau-count').text(bureauCount);
        }

        function renderTable(data) {
            STATE.table.clear();

            const rows = data.map(item => {
                const c = item.computed;
                const r = item.raw;

                // Badge Logic
                let badgeClass = 'bg-good';
                if (c.urgency === 'CRITICAL') badgeClass = 'bg-critical';
                if (c.urgency === 'WARNING') badgeClass = 'bg-warning';
                if (c.urgency === 'EXPIRED') badgeClass = 'bg-expired';

                return;
            });

            STATE.table.rows.add(rows).draw();
        }

        function renderChart(data) {
            // Optimization: If too many rows, slice top 50 by urgency for chart clarity
            // Or aggregate. For this dashboard, we will sort by end date and show top 40.
            const chartData = [...data]
               .sort((a, b) => a.computed.end - b.computed.end) // So earliest are at top? No, usually charts perform better with limited datasets.
               .filter(d => d.computed.urgency!== 'EXPIRED') // Hide expired on chart for clarity
               .slice(0, 50); // Performance Limit

            const seriesData = chartData.map(d => {
                return {
                    x: d.raw.contract_acronym |

| d.raw.contract_number,
                    y:,
                    fillColor: d.computed.color,
                    // Meta for tooltip
                    goals: [
                        { name: 'Value', value: d.computed.total, strokeHeight: 0 } // Hack to pass data
                    ],
                    meta: d // Custom property for tooltip
                };
            });

            const options = {
                series:,
                chart: {
                    height: Math.max(500, chartData.length * 30), // Dynamic Height
                    type: 'rangeBar',
                    fontFamily: 'Segoe UI, sans-serif',
                    toolbar: { show: true }
                },
                plotOptions: {
                    bar: {
                        horizontal: true,
                        barHeight: '60%',
                        borderRadius: 4
                    }
                },
                xaxis: {
                    type: 'datetime',
                    position: 'top' // Calendar on top is easier to read
                },
                grid: {
                    xaxis: { lines: { show: true } },
                    yaxis: { lines: { show: true } }
                },
                tooltip: {
                    custom: function({series, seriesIndex, dataPointIndex, w}) {
                        const d = w.config.series[seriesIndex].data[dataPointIndex].meta;
                        const c = d.computed;
                        const r = d.raw;
                        
                        return `
                            <div class="apexcharts-tooltip-custom">
                                <div class="tooltip-header">
                                    ${r.contract_number}
                                </div>
                                <div class="tooltip-body">
                                    <div class="tooltip-row">
                                        <span class="tooltip-lbl">Vendor:</span>
                                        <span class="tooltip-val">${r.vendor_name}</span>
                                    </div>
                                    <div class="tooltip-row">
                                        <span class="tooltip-lbl">Value:</span>
                                        <span class="tooltip-val text-success">${formatCurrency.format(c.total)}</span>
                                    </div>
                                    <div class="tooltip-row">
                                        <span class="tooltip-lbl">Expires:</span>
                                        <span class="tooltip-val text-warning">${c.end.toLocaleDateString()}</span>
                                    </div>
                                    <div class="tooltip-row">
                                        <span class="tooltip-lbl">Status:</span>
                                        <span class="tooltip-val">${c.daysLeft} Days Remaining</span>
                                    </div>
                                    <div class="tooltip-row" style="margin-top:8px; padding-top:8px; border-top:1px dashed #374151;">
                                        <span class="tooltip-lbl">Bureau:</span>
                                        <span class="tooltip-val">${c.bureau}</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                }
            };

            if (STATE.chart) {
                STATE.chart.destroy();
            }
            
            STATE.chart = new ApexCharts(document.querySelector("#timelineChart"), options);
            STATE.chart.render();
        }

    </script>
</body>
</html>
