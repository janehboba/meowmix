<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contract Renewal Intelligence Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #334155; }
       .chart-container { position: relative; width: 100%; height: 300px; max-height: 400px; margin: 0 auto; }
       .chart-container-lg { position: relative; width: 100%; height: 400px; max-height: 500px; margin: 0 auto; }
       .custom-scroll::-webkit-scrollbar { width: 8px; height: 8px; }
       .custom-scroll::-webkit-scrollbar-track { background: #f1f5f9; }
       .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
       .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Loading Spinner */
       .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            display: none;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <nav class="bg-white border-b border-gray-200 shadow-sm sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <span class="text-indigo-600 font-bold text-xl mr-8">ContractScope</span>
                    <div class="flex items-center space-x-2">
                        <label class="block text-sm font-medium text-gray-700 mr-2">Upload Data:</label>
                        <input type="file" id="csv-upload" accept=".csv" class="block w-full text-sm text-slate-500
                          file:mr-4 file:py-2 file:px-4
                          file:rounded-full file:border-0
                          file:text-sm file:font-semibold
                          file:bg-indigo-50 file:text-indigo-700
                          hover:file:bg-indigo-100
                        "/>
                        <div class="loader" id="loading-spinner"></div>
                    </div>
                </div>
                <div class="flex items-center">
                    <span class="text-sm text-gray-500" id="current-date"></span>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-4">
        <div id="status-box" class="hidden p-4 rounded-md">
            <div class="flex">
                <div class="ml-3">
                    <h3 class="text-sm font-medium" id="status-title">Status</h3>
                    <div class="mt-2 text-sm" id="status-message"></div>
                </div>
            </div>
        </div>
    </div>

    <main class="flex-1 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 w-full">

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-white overflow-hidden shadow rounded-lg border border-gray-100">
                <div class="p-5">
                    <dl>
                        <dt class="text-sm font-medium text-gray-500 truncate">Total Active Contracts</dt>
                        <dd class="text-2xl font-semibold text-gray-900" id="kpi-total-contracts">-</dd>
                    </dl>
                </div>
            </div>

            <div class="bg-white overflow-hidden shadow rounded-lg border border-red-100">
                <div class="p-5">
                    <dl>
                        <dt class="text-sm font-medium text-gray-500 truncate">Value at Risk (< 90 Days)</dt>
                        <dd class="text-2xl font-semibold text-red-600" id="kpi-value-risk">-</dd>
                    </dl>
                </div>
            </div>

            <div class="bg-white overflow-hidden shadow rounded-lg border border-orange-100">
                <div class="p-5">
                    <dl>
                        <dt class="text-sm font-medium text-gray-500 truncate">Urgent Renewals</dt>
                        <dd class="text-2xl font-semibold text-gray-900" id="kpi-urgent-count">-</dd>
                        <dd class="text-xs text-orange-600 font-bold mt-1">Due in < 3 Months</dd>
                    </dl>
                </div>
            </div>

            <div class="bg-white overflow-hidden shadow rounded-lg border border-green-100">
                <div class="p-5">
                    <dl>
                        <dt class="text-sm font-medium text-gray-500 truncate">Top Vendor</dt>
                        <dd class="text-lg font-semibold text-gray-900 truncate" id="kpi-top-vendor">-</dd>
                    </dl>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
            <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 lg:col-span-2">
                <h3 class="text-lg font-medium text-gray-900 mb-2">Renewal Timeline</h3>
                <div class="chart-container-lg">
                    <canvas id="timelineChart"></canvas>
                </div>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                <h3 class="text-lg font-medium text-gray-900 mb-2">Funding by Bureau</h3>
                <div class="chart-container">
                    <canvas id="fundingChart"></canvas>
                </div>
            </div>
        </div>

        <div id="data-grid" class="bg-white shadow rounded-lg border border-gray-200 overflow-hidden">
            <div class="px-6 py-5 border-b border-gray-200 bg-gray-50">
                <h3 class="text-lg font-medium leading-6 text-gray-900">Contract Register</h3>
            </div>
            <div class="overflow-x-auto custom-scroll max-h-[600px]">
                <table class="min-w-full divide-y divide-gray-200 relative">
                    <thead class="bg-gray-50 sticky top-0 z-10">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Contract #</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Vendor</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Bureau</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">End Date</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Total</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Days Left</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="contracts-table-body">
                        <tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">Upload a CSV file to see data.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

    </main>

    <script>
        // --- GLOBAL STATE ---
        let charts = { timeline: null, funding: null };
        const EXPECTED_HEADERS = [
            'contract_number', 'contract_total', 'contract_end_date', 'contract_start_date', 
            'vendor_name', 'funding_bureau'
        ];

        // --- UTILITY: HELPERS ---
        const formatCurrency = (num) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(num);
        
        const cleanNumber = (val) => {
            if (typeof val === 'number') return val;
            if (!val) return 0;
            // Remove $ , and spaces
            const cleaned = val.toString().replace(/[^0-9.-]+/g,"");
            return parseFloat(cleaned) || 0;
        };

        const parseDate = (val) => {
            if (!val) return null;
            const d = new Date(val);
            if (isNaN(d.getTime())) return null; // Invalid date
            return d;
        };

        const getDaysRemaining = (endDateObj) => {
            if(!endDateObj) return -9999;
            const now = new Date();
            const diffTime = endDateObj - now;
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
        };

        // --- 1. CSV HANDLING ---
        document.getElementById('csv-upload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            // UI Updates
            document.getElementById('loading-spinner').style.display = 'block';
            showStatus('blue', 'Processing...', 'Parsing CSV file. Please wait.');

            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                transformHeader: (h) => h.trim(), // Remove spaces from headers
                complete: function(results) {
                    document.getElementById('loading-spinner').style.display = 'none';
                    
                    if (results.errors.length > 0) {
                        console.warn("CSV Errors:", results.errors);
                    }

                    if (results.data && results.data.length > 0) {
                        validateAndProcess(results.data, results.meta.fields);
                    } else {
                        showStatus('red', 'Error', 'No data found in the CSV file.');
                    }
                },
                error: function(err) {
                    document.getElementById('loading-spinner').style.display = 'none';
                    showStatus('red', 'File Read Error', err.message);
                }
            });
        });

        // --- 2. VALIDATION & TRANSFORMATION ---
        function validateAndProcess(data, headers) {
            console.log("Raw Headers Found:", headers);
            
            let validRows = [];
            let skippedCount = 0;

            data.forEach(row => {
                // We need at least a Contract Number and End Date
                const cNum = row['contract_number'];
                const cEnd = row['contract_end_date'];
                
                if (!cNum && !cEnd) {
                    skippedCount++;
                    return; 
                }

                const startDate = parseDate(row['contract_start_date']);
                const endDate = parseDate(row['contract_end_date']);
                const total = cleanNumber(row['contract_total']);

                if (!endDate) {
                    skippedCount++;
                    return; 
                }

                validRows.push({
                    number: cNum || 'Unknown',
                    vendor: row['vendor_name'] || 'Unknown Vendor',
                    bureau: row['funding_bureau'] || 'Unassigned',
                    title: row['contract_title'] || '',
                    acronym: row['contract_acronym'] || cNum,
                    start: startDate || new Date(), // Fallback for start
                    end: endDate,
                    total: total,
                    daysLeft: getDaysRemaining(endDate)
                });
            });

            if (validRows.length === 0) {
                showStatus('red', 'Data Error', `Parsed ${data.length} rows but found 0 valid entries. Check that your columns are named exactly: contract_end_date, contract_number, contract_total.`);
                return;
            }

            // Success
            showStatus('green', 'Success', `Loaded ${validRows.length} contracts. (Skipped ${skippedCount} invalid/empty rows).`);
            
            // Sort by Date
            validRows.sort((a, b) => a.end - b.end);

            updateDashboard(validRows);
        }

        // --- 3. UI UPDATER ---
        function updateDashboard(data) {
            // A. Metrics
            const totalVal = data.reduce((acc, curr) => acc + curr.total, 0);
            const riskData = data.filter(d => d.daysLeft >= 0 && d.daysLeft <= 90);
            const riskVal = riskData.reduce((acc, curr) => acc + curr.total, 0);
            
            // Top Vendor
            const vendorCounts = {};
            data.forEach(d => { vendorCounts[d.vendor] = (vendorCounts[d.vendor] || 0) + d.total; });
            const topVendorName = Object.keys(vendorCounts).reduce((a, b) => vendorCounts[a] > vendorCounts[b]? a : b, '-');

            document.getElementById('kpi-total-contracts').innerText = data.length;
            document.getElementById('kpi-value-risk').innerText = formatCurrency(riskVal);
            document.getElementById('kpi-urgent-count').innerText = riskData.length;
            document.getElementById('kpi-top-vendor').innerText = topVendorName;

            // B. Populate Table
            const tbody = document.getElementById('contracts-table-body');
            tbody.innerHTML = '';
            
            data.forEach(d => {
                const tr = document.createElement('tr');
                let statusBadge = '';
                let rowClass = '';

                if (d.daysLeft < 0) {
                    statusBadge = '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">Expired</span>';
                } else if (d.daysLeft <= 30) {
                    statusBadge = '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">Critical</span>';
                    rowClass = 'bg-red-50';
                } else if (d.daysLeft <= 90) {
                    statusBadge = '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-orange-100 text-orange-800">Warning</span>';
                } else {
                    statusBadge = '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Good</span>';
                }

                tr.className = rowClass? rowClass : 'hover:bg-gray-50';
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">${statusBadge}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${d.number}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${d.vendor}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${d.bureau}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${d.end.toISOString().split('T')[0]}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-right">${formatCurrency(d.total)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-bold">${d.daysLeft} days</td>
                `;
                tbody.appendChild(tr);
            });

            // C. Charts
            renderTimeline(data);
            renderFunding(data);
        }

        // --- 4. CHARTS RENDERER ---
        function renderTimeline(data) {
            // Limit to top 20 urgent (non-expired) for readability
            const chartData = data
               .filter(d => d.daysLeft > -30) // Show recently expired and future
               .slice(0, 20);

            const ctx = document.getElementById('timelineChart').getContext('2d');
            
            if (charts.timeline) charts.timeline.destroy();

            // Prepare for Chart.js
            const labels = chartData.map(d => d.acronym || d.number);
            const dataset = chartData.map(d => {
                return {
                    x: [d.start.getTime(), d.end.getTime()],
                    y: d.acronym || d.number,
                    vendor: d.vendor
                };
            });

            charts.timeline = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Contract Period',
                        data: dataset,
                        backgroundColor: (ctx) => {
                             if (!ctx.raw) return '#e2e8f0';
                             const end = ctx.raw.x[1];
                             const now = Date.now();
                             const diff = (end - now) / (1000 * 60 * 60 * 24);
                             if (diff < 30) return '#ef4444'; // Red
                             if (diff < 90) return '#f97316'; // Orange
                             return '#3b82f6'; // Blue
                        },
                        borderRadius: 4,
                        barPercentage: 0.5
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'linear',
                            position: 'top',
                            min: Date.now() - (1000*60*60*24*30), // Start view 30 days ago
                            ticks: {
                                callback: (val) => new Date(val).toLocaleDateString('en-US', {month:'short', year:'2-digit'})
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: (ctx) => {
                                    const end = new Date(ctx.raw.x[1]).toLocaleDateString();
                                    return `${ctx.raw.vendor}: Ends ${end}`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderFunding(data) {
            // Aggregate
            const bureauTotals = {};
            data.forEach(d => { bureauTotals[d.bureau] = (bureauTotals[d.bureau] || 0) + d.total; });
            
            const labels = Object.keys(bureauTotals);
            const values = Object.values(bureauTotals);

            const ctx = document.getElementById('fundingChart').getContext('2d');
            if (charts.funding) charts.funding.destroy();

            charts.funding = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#6366f1', '#ec4899', '#8b5cf6'],
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }

        function showStatus(color, title, message) {
            const el = document.getElementById('status-box');
            const titleEl = document.getElementById('status-title');
            const msgEl = document.getElementById('status-message');
            
            el.className = `p-4 rounded-md mb-6 ${color === 'red'? 'bg-red-50 text-red-800' : (color === 'green'? 'bg-green-50 text-green-800' : 'bg-blue-50 text-blue-800')}`;
            el.classList.remove('hidden');
            
            titleEl.innerText = title;
            msgEl.innerText = message;
        }

        // Set Date
        document.getElementById('current-date').textContent = new Date().toLocaleDateString();
    </script>
</body>
</html>
